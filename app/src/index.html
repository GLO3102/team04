<!doctype html>
<html lang="en">
<head>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>UMI ULaval Movie Ima by 300 UMI</title>

    <link rel="icon"
          type="image/png"
          href="image/umi-project-logo-500x500.png?v=42">

    <link href='https://fonts.googleapis.com/css?family=Varela+Round' rel='stylesheet' type='text/css'>
    <link rel="stylesheet" href="/css/app.min.css">
    <link rel="stylesheet" href="/css/vendor.min.css">
</head>
<body>

<div class="page">

    <div class="template-pageHeader"></div>
    <div class="template-pageContent"></div>
    <div class="template-pageFooter"></div>

</div>

<script src="/js/vendor.min.js" type="text/javascript"></script>
<script src="/js/app.min.js" type="text/javascript"></script>
<script src="/js/template.min.js" type="text/javascript"></script>

<script>
    function htmlEncode(value){
        return $('<div/>').text(value).html();
    }
    $.fn.serializeObject = function() {
        var o = {};
        var a = this.serializeArray();
        $.each(a, function() {
            if (o[this.name] !== undefined) {
                if (!o[this.name].push) {
                    o[this.name] = [o[this.name]];
                }
                o[this.name].push(this.value || '');
            } else {
                o[this.name] = this.value || '';
            }
        });
        return o;
    };

    nunjucks.configure('/', { autoescape: true });
    var pageHeader = nunjucks.render('pageHeader.nunj.html', {});
    $('.template-pageHeader').html(pageHeader);

    var pageFooter = nunjucks.render('pageFooter.nunj.html', {});
    $('.template-pageFooter').html(pageFooter);

    $.ajaxPrefilter( function( options, originalOptions, jqXHR ) {
        options.url = 'http://backbone-beginner.herokuapp.com' + options.url;
    });
    var Users = Backbone.Collection.extend({
        url: '/users'
    });
    var User = Backbone.Model.extend({
        urlRoot: '/users'
    });
    var UserListView = Backbone.View.extend({
        el: '.template-pageContent',
        render: function () {
            var self = this;
            var users = new Users();
            users.fetch({
                success: function (users) {
                    var html = nunjucks.render('userList.nunj.html', {users: users.toJSON()});
                    self.$el.html(html);
                }
            })
        }
    });
    var userListView = new UserListView();
    var UserEditView = Backbone.View.extend({
        el: '.template-pageContent',
        events: {
            'submit .editUserForm': 'saveUser',
            'click .delete': 'deleteUser'
        },
        saveUser: function (ev) {
            var userDetails = $(ev.currentTarget).serializeObject();
            var user = new User();
            user.save(userDetails, {
                success: function (user) {
                    router.navigate('', {trigger:true});
                }
            });
            return false;
        },
        deleteUser: function (ev) {
            this.user.destroy({
                success: function () {
                    console.log('destroyed');
                    router.navigate('', {trigger:true});
                }
            });
            return false;
        },
        render: function (options) {
            var self = this;
            if(options.id) {
                self.user = new User({id: options.id});
                self.user.fetch({
                    success: function (user) {
                        var html = nunjucks.render('editUserForm.nunj.html', {user: user.toJSON()});
                        self.$el.html(html);
                    }
                })
            } else {
                var html = nunjucks.render('editUserForm.nunj.html', {user: null});
                self.$el.html(html);
            }
        }
    });
    var userEditView = new UserEditView();
    var Router = Backbone.Router.extend({
        routes: {
            "": "home",
            "edit/:id": "edit",
            "new": "edit"
        }
    });
    var router = new Router;
    router.on('route:home', function() {
        // render user list
        userListView.render();
    });
    router.on('route:edit', function(id) {
        userEditView.render({id: id});
    });
    Backbone.history.start({
        pushState: true,
        root: '/'
    });

    // Correction : Ã©vite l'utilisation de #/new (etc)
    // de http://artsy.github.io/blog/2012/06/25/replacing-hashbang-routes-with-pushstate/
    $(document).on("click", "a[href^='/']", function(event) {
        var href, passThrough, url;
        href = $(event.currentTarget).attr('href');
        passThrough = href.indexOf('sign_out') >= 0;
        if (!passThrough && !event.altKey && !event.ctrlKey && !event.metaKey && !event.shiftKey) {
            event.preventDefault();
            url = href.replace(/^\//, '').replace('\#\!\/', '');
            router.navigate(url, {
                trigger: true
            });
            return false;
        }
    });
</script>


</body>
</html>
